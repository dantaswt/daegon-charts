<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>daegon charts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .loader {
            border: 4px solid #e5e7eb; /* gray-200 */
            border-top: 4px solid #dc2626; /* red-600 */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .history-view {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-nav-btn.active {
            background-color: #dc2626; /* red-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-full">
    <header class="bg-white border-b border-gray-200 sticky top-0 z-20">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 text-center">
                <a href="#" onclick="window.location.reload()">daegon charts</a>
            </h1>
        </div>
    </header>

    <main id="app" class="flex-grow container mx-auto p-4 md:p-6">
        </main>

    <footer class="bg-white mt-8 py-4 border-t border-gray-200">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>Chart generated based on dantaswt's Last.fm data</p>
        </div>
    </footer>

    <script>
        // --- CONFIGURATION ---
        const chartsConfig = {
            songs: {
                url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=904867620',
                title: 'Hot 100',
                entityType: 'song',
                loaded: false
            },
            artists: {
                url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=1090187257',
                title: 'Artist 50',
                entityType: 'artist',
                loaded: false
            },
            albums: {
                url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=916902523',
                title: 'Top 100 Albums',
                entityType: 'album',
                loaded: false
            }
        };

        // --- DOM ELEMENTS ---
        const appContainer = document.getElementById('app');

        // --- GLOBAL VARIABLES ---
        let activeChart = 'songs';
        let allData = { songs: {}, artists: {}, albums: {} };
        let allHistories = { songs: {}, artists: {}, albums: {} };
        let artistStats = {};
        let colMaps = { songs: {}, artists: {}, albums: {} };
        const artworkCache = {};
        let currentView = 'main';
        let currentArtist = null;
        let lastSelectedWeeks = {};

        // --- PAGE RENDERING FUNCTIONS ---
        function renderMainPage() {
            currentView = 'main';
            currentArtist = null;
            appContainer.innerHTML = `
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg max-w-5xl mx-auto">
                    <div id="chartNav" class="mb-6 flex justify-center border-b border-gray-200">
                        <button data-chart="songs" class="chart-nav-btn text-base sm:text-lg font-semibold py-3 px-3 sm:px-6 text-gray-500 hover:text-gray-900 focus:outline-none">Hot 100</button>
                        <button data-chart="artists" class="chart-nav-btn text-base sm:text-lg font-semibold py-3 px-3 sm:px-6 text-gray-500 hover:text-gray-900 focus:outline-none">Artist 50</button>
                        <button data-chart="albums" class="chart-nav-btn text-base sm:text-lg font-semibold py-3 px-3 sm:px-6 text-gray-500 hover:text-gray-900 focus:outline-none">Top 100 Albums</button>
                    </div>
                    <div id="chartHeader" class="mb-6">
                        <h2 id="chartTitle" class="text-3xl font-bold text-center text-gray-900"></h2>
                        <div class="mt-3 flex flex-col sm:flex-row justify-center items-center gap-3 sm:gap-4">
                            <div class="flex items-center gap-2">
                                <label for="weekSelector" class="text-gray-600">Select Week:</label>
                                <button id="prevWeekBtn" class="p-2 rounded-md bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed" title="Previous Week"><</button>
                                <select id="weekSelector" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-md shadow-sm focus:border-red-500 focus:ring-red-500"></select>
                                <button id="nextWeekBtn" class="p-2 rounded-md bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed" title="Next Week">></button>
                            </div>
                        </div>
                    </div>
                    <div id="chartContainer"></div>
                </div>
            `;
            setupMainPageListeners();
            switchChart(activeChart, true);
        }
        
        async function renderArtistPage(artistName) {
            currentView = 'artistPage';
            currentArtist = artistName;
            const stats = artistStats[artistName] || { songs: {}, albums: {} };
            const songStats = stats.songs || { numberOnes: 0, top10s: 0, totalEntries: 0 };
            const albumStats = stats.albums || { numberOnes: 0, top10s: 0, totalEntries: 0 };

            appContainer.innerHTML = `
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg max-w-5xl mx-auto">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b border-gray-200 pb-4 gap-2">
                         <button id="backButton" class="text-red-600 font-semibold hover:underline order-1 sm:order-1">‚Äπ Back to Chart</button>
                         <h2 class="text-2xl sm:text-3xl font-bold text-center text-gray-900 order-2 sm:order-2 flex-grow">${artistName}</h2>
                         <div class="w-32 order-1 sm:order-3 hidden sm:block"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center mb-6 py-4 bg-gray-50 rounded-lg">
                        <div class="px-2">
                            <h4 class="font-bold mb-2 text-gray-700">Songs</h4>
                            <div class="grid grid-cols-3">
                                <div><p class="text-3xl font-bold text-red-600">${songStats.numberOnes}</p><p class="text-sm text-gray-600">#1s</p></div>
                                <div><p class="text-3xl font-bold text-red-600">${songStats.top10s}</p><p class="text-sm text-gray-600">Top 10s</p></div>
                                <div><p class="text-3xl font-bold text-red-600">${songStats.totalEntries}</p><p class="text-sm text-gray-600">Entries</p></div>
                            </div>
                        </div>
                        <div class="px-2">
                             <h4 class="font-bold mb-2 text-gray-700">Albums</h4>
                            <div class="grid grid-cols-3">
                                <div><p class="text-3xl font-bold text-red-600">${albumStats.numberOnes}</p><p class="text-sm text-gray-600">#1s</p></div>
                                <div><p class="text-3xl font-bold text-red-600">${albumStats.top10s}</p><p class="text-sm text-gray-600">Top 10s</p></div>
                                <div><p class="text-3xl font-bold text-red-600">${albumStats.totalEntries}</p><p class="text-sm text-gray-600">Entries</p></div>
                            </div>
                        </div>
                    </div>
                    <div id="artistSongsContainer" class="mb-8">
                         <h3 class="text-xl font-bold text-gray-800 mb-4">Hot 100 Song History</h3>
                         <div id="artistSongsHistory"></div>
                    </div>
                    <div id="artistAlbumsContainer">
                         <h3 class="text-xl font-bold text-gray-800 mb-4">Top 100 Albums History</h3>
                         <div id="artistAlbumsHistory"></div>
                    </div>
                </div>
            `;
            document.getElementById('backButton').addEventListener('click', renderMainPage);
            await displayArtistHistoryCharts(artistName);
        }

        // --- LOGIC FUNCTIONS ---
        function showMessage(type, text, container = document.getElementById('chartContainer')) {
            if (!container) return;
            container.innerHTML = '';
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex flex-col items-center justify-center p-8';
            if (type === 'loading') {
                messageDiv.innerHTML = `<div class="loader mb-4"></div><p class="text-gray-600">${text}</p>`;
            } else {
                messageDiv.innerHTML = `<p class="text-center text-red-600 font-semibold">${text}</p>`;
            }
            container.appendChild(messageDiv);
        }

        function parseCsvRow(text) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') { inQuotes = !inQuotes; } 
                else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else { current += char; }
            }
            result.push(current.trim());
            return result;
        }

        function computeArtistStats() {
            artistStats = {};
            for (const chartType of ['songs', 'albums']) {
                if (!chartsConfig[chartType].loaded) continue;
                for (const entityKey in allHistories[chartType]) {
                    const [artist, entityName] = entityKey.split('|');
                    const history = allHistories[chartType][entityKey];
                    if (!artistStats[artist]) artistStats[artist] = { songs: { totalEntries: 0, top10s: 0, numberOnes: 0, items: [] }, albums: { totalEntries: 0, top10s: 0, numberOnes: 0, items: [] } };
                    
                    const peak = Math.min(...history.map(h => parseInt(h.position)));
                    const weeks = history.length;
                    
                    if (!artistStats[artist][chartType].items.some(item => item.name === entityName)) {
                        artistStats[artist][chartType].totalEntries++;
                        if (peak <= 10) artistStats[artist][chartType].top10s++;
                        if (peak === 1) artistStats[artist][chartType].numberOnes++;
                        artistStats[artist][chartType].items.push({ name: entityName, peak, weeks, history });
                    }
                }
            }
        }

        async function fetchAndProcessChartData(chartType) {
            if (chartsConfig[chartType].loaded) return;
            const config = chartsConfig[chartType];
            const url = `${config.url}&_=${new Date().getTime()}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Could not access the spreadsheet for ${config.title}.`);
            
            let csvText = await response.text();
            if (csvText.charCodeAt(0) === 0xFEFF) { csvText = csvText.substring(1); }

            const rows = csvText.trim().split('\n').map(row => parseCsvRow(row));
            if (rows.length < 2) throw new Error(`The spreadsheet for ${config.title} does not contain enough data.`);

            const header = rows[0].map(h => h.toLowerCase());
            const data = rows.slice(1);

            const findIndex = (keys) => {
                for (const key of keys) {
                    const index = header.indexOf(key);
                    if (index !== -1) return index;
                }
                return -1;
            };

            colMaps[chartType] = {
                date: findIndex(['date', 'chart date']),
                position: findIndex(['position', 'rank']),
                diff: findIndex(['dif', 'diff', '‚ñ≤‚ñº']),
                song: findIndex(['song']),
                album: findIndex(['album']),
                artist: findIndex(['artist', 'artists']),
                lastWeek: findIndex(['last week', 'lw']),
                peak: findIndex(['peak']),
                weeks: findIndex(['weeks']),
                sales: findIndex(['sales']),
                streaming: findIndex(['streaming']),
                units: findIndex(['units']),
                totalUnits: findIndex(['total units']),
                certification: findIndex(['certification'])
            };

            if (colMaps[chartType].position === -1) throw new Error(`Position column not found for ${config.title}.`);
            if (colMaps[chartType].date === -1) throw new Error(`Date column not found for ${config.title}.`);
            if (colMaps[chartType].artist === -1) throw new Error(`Artist column not found for ${config.title}.`);

            const sortedDates = [...new Set(data.map(row => row[colMaps[chartType].date]))]
                .sort((a, b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));

            sortedDates.forEach(date => { allData[chartType][date] = []; });

            data.forEach(row => {
                const date = row[colMaps[chartType].date];
                if (allData[chartType][date]) {
                    allData[chartType][date].push(row);
                    const artist = row[colMaps[chartType].artist];
                    const entityName = row[colMaps[chartType][config.entityType]];
                    const entityKey = config.entityType === 'artist' ? artist : `${artist}|${entityName}`;
                    const position = row[colMaps[chartType].position];
                    if (!allHistories[chartType][entityKey]) allHistories[chartType][entityKey] = [];
                    allHistories[chartType][entityKey].push({ date, position });
                }
            });
            chartsConfig[chartType].loaded = true;
        }

        function populateWeekSelector() {
            const weekSelector = document.getElementById('weekSelector');
            if (!weekSelector) return;
            const dates = Object.keys(allData[activeChart]).sort((a, b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
            weekSelector.innerHTML = '';
            dates.forEach(dateStr => {
                const option = document.createElement('option');
                option.value = dateStr;
                option.textContent = dateStr;
                weekSelector.appendChild(option);
            });
        }
        
        function getDiffStyle(diff) {
            if (!diff) return { colorClass: 'text-gray-500', icon: '' };
            const cleanedDiff = diff.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
            if (cleanedDiff === 'NEW') return { colorClass: 'text-blue-600', icon: '‚òÖ' };
            if (cleanedDiff === 'RE') return { colorClass: 'text-yellow-600', icon: '‚Ü©' };
            if (cleanedDiff === '0') return { colorClass: 'text-gray-500', icon: '‚ñ¨' };
            if (diff.includes('‚ñ≤') || diff.includes('‚Üë')) return { colorClass: 'text-green-600', icon: '‚ñ≤' };
            if (diff.includes('‚ñº') || diff.includes('‚Üì')) return { colorClass: 'text-red-600', icon: '‚ñº' };
            return { colorClass: 'text-gray-500', icon: '' };
        }
        
        // --- NEW, ROBUST IMAGE FETCHING LOGIC ---
        async function getArtworkImage(artist, name, type) {
            const key = name ? `${artist}|${name}` : artist;
            if (artworkCache[key]) return artworkCache[key];

            let imageUrl = null;

            if (type === 'album' || type === 'song') {
                // Attempt 1: Get album art from The AudioDB
                imageUrl = await getAlbumArtFromAudioDB(artist, name);
                if (imageUrl) return cacheAndReturn(key, imageUrl);

                // Attempt 2: Get album art from MusicBrainz + Cover Art Archive
                imageUrl = await getAlbumArtFromMusicBrainz(artist, name);
                if (imageUrl) return cacheAndReturn(key, imageUrl);

                // Attempt 3 (FALLBACK): Get ARTIST image from The AudioDB
                console.log(`Artwork for '${name}' not found. Falling back to artist image for '${artist}'.`);
                imageUrl = await getArtistArtFromAudioDB(artist);
                if (imageUrl) return cacheAndReturn(key, imageUrl);

            } else if (type === 'artist') {
                // Attempt 1: Get ARTIST image from The AudioDB
                imageUrl = await getArtistArtFromAudioDB(artist);
                if (imageUrl) return cacheAndReturn(key, imageUrl);
            }

            return cacheAndReturn(key, 'not_found');
        }

        function cacheAndReturn(key, url) {
            artworkCache[key] = url;
            return url;
        }

        async function getAlbumArtFromAudioDB(artist, albumName) {
            try {
                const url = `https://www.theaudiodb.com/api/v1/json/2/searchalbum.php?s=${encodeURIComponent(artist)}&a=${encodeURIComponent(albumName)}`;
                const response = await fetch(url);
                if (!response.ok) return null;
                const data = await response.json();
                return data?.album?.[0]?.strAlbumThumb || null;
            } catch (error) {
                console.error("Error fetching from The AudioDB:", error);
                return null;
            }
        }
        
        async function getArtistArtFromAudioDB(artist) {
            try {
                const url = `https://www.theaudiodb.com/api/v1/json/2/search.php?s=${encodeURIComponent(artist)}`;
                const response = await fetch(url);
                if (!response.ok) return null;
                const data = await response.json();
                return data?.artists?.[0]?.strArtistThumb || null;
            } catch (error) {
                console.error("Error fetching artist art from The AudioDB:", error);
                return null;
            }
        }

        async function getAlbumArtFromMusicBrainz(artist, albumName) {
            try {
                // Step 1: Get the release MBID from MusicBrainz
                const mbUrl = `https://musicbrainz.org/ws/2/release/?query=release:${encodeURIComponent(albumName)}%20AND%20artist:${encodeURIComponent(artist)}&fmt=json`;
                const mbResponse = await fetch(mbUrl, { headers: { 'User-Agent': 'DaegonCharts/1.0' } });
                if (!mbResponse.ok) return null;
                const mbData = await mbResponse.json();
                const releaseId = mbData?.releases?.[0]?.id;

                if (!releaseId) return null;

                // Step 2: Use the MBID to get the cover art from the Cover Art Archive
                const caUrl = `https://coverartarchive.org/release/${releaseId}/front`;
                const caResponse = await fetch(caUrl, { method: 'HEAD' }); // Use HEAD to check if image exists without downloading it
                return caResponse.ok && caResponse.redirected ? caResponse.url : null;

            } catch (error) {
                console.error("Error fetching from MusicBrainz/CoverArtArchive:", error);
                return null;
            }
        }

        async function displayActiveChart(dateKey) {
            const chartContainer = document.getElementById('chartContainer');
            const chartData = allData[activeChart][dateKey];
            showMessage('loading', `Building ${chartsConfig[activeChart].title} chart...`, chartContainer);

            if (!chartData || chartData.length === 0) {
                showMessage('info', 'No data found for the selected week.', chartContainer);
                return;
            }
            
            const sortedChartData = chartData.sort((a, b) => a[colMaps[activeChart].position] - b[colMaps[activeChart].position]);
            const displayData = activeChart === 'artists' ? sortedChartData.slice(0, 50) : sortedChartData;
            
            chartContainer.innerHTML = '';

            let maxSales = 0, maxStreams = 0;
            if (activeChart === 'albums' || activeChart === 'songs') {
                const salesValues = displayData.map(row => parseInt(row[colMaps[activeChart].sales]?.replace(/,/g, '')) || 0);
                const streamsValues = displayData.map(row => parseInt(row[colMaps[activeChart].streaming]?.replace(/,/g, '')) || 0);
                maxSales = Math.max(...salesValues);
                maxStreams = Math.max(...streamsValues);
            }

            displayData.forEach(row => {
                const chartRow = createChartRow(row, { maxSales, maxStreams });
                chartContainer.appendChild(chartRow);
            });
        }
        
        function getCertificationEmoji(certText) {
            if (!certText) return { emoji: '', title: '' };
            const lowerCert = certText.toLowerCase();
            if (lowerCert.includes('gold') || lowerCert.includes('ouro')) return { emoji: 'üìÄ', title: 'Gold' };
            if (lowerCert.includes('platinum') || lowerCert.includes('platina')) return { emoji: 'üíø', title: 'Platinum'};
            if (lowerCert.includes('diamond') || lowerCert.includes('diamante')) return { emoji: 'üíé', title: 'Diamond'};
            return { emoji: '', title: '' };
        }

        function createChartRow(row, options = {}) {
            const config = chartsConfig[activeChart];
            const colMap = colMaps[activeChart];
            const pos = row[colMap.position], diff = row[colMap.diff], artist = row[colMap.artist];
            const name = config.entityType !== 'artist' ? row[colMap[config.entityType]] : null;
            const lastWeek = row[colMap.lastWeek] || '-', peak = row[colMap.peak] || '-', weeks = row[colMap.weeks] || '-';
            const entityKey = name ? `${artist}|${name}` : artist;

            const { colorClass, icon } = getDiffStyle(diff);
            
            const chartRow = document.createElement('div');
            chartRow.className = 'py-3 border-b border-gray-200';
            chartRow.dataset.entityKey = entityKey;
            
            const initials = artist.split(' ').map(n => n[0]).join('').substring(0, 2);
            const imagePlaceholder = `<div class="w-12 h-12 sm:w-16 sm:h-16 bg-gray-200 rounded-md flex items-center justify-center font-bold text-gray-500 text-lg shadow-md">${initials}</div>`;
            
            let extraInfo = '';
            if (config.entityType === 'albums' || config.entityType === 'songs') {
                const units = row[colMap.units] || null, totalUnits = row[colMap.totalUnits] || null;
                const certText = row[colMap.certification] || '';
                const { emoji, title } = getCertificationEmoji(certText);
                const certEmojiSpan = emoji ? `<span class="ml-2" title="${title}">${emoji}</span>` : '';

                let certInfo = '';
                if (units && totalUnits) {
                    certInfo = `<div class="flex items-center text-xs text-gray-500 mt-1"><span>Units: <strong class="text-gray-700">${units} / ${totalUnits}</strong></span>${certEmojiSpan}</div>`;
                } else if (certEmojiSpan) {
                     certInfo = `<div class="flex items-center text-xs text-gray-500 mt-1">${certEmojiSpan}</div>`
                }
                
                const sales = parseInt(row[colMap.sales]?.replace(/,/g, '')) || 0;
                const streams = parseInt(row[colMap.streaming]?.replace(/,/g, '')) || 0;
                const salesAward = (sales > 0 && sales === options.maxSales) ? '<span title="Top Sales">üèÜ</span>' : '';
                const streamsAward = (streams > 0 && streams === options.maxStreams) ? '<span title="Top Streamer">üî•</span>' : '';
                
                extraInfo = `<div class="flex justify-between items-start w-full">${certInfo}<div class="ml-auto text-base flex-shrink-0">${salesAward} ${streamsAward}</div></div>`;
            }

            const statsBlock = `<div class="flex items-center text-center text-xs sm:text-sm"><div class="px-2 sm:px-3 md:px-4"><p class="font-semibold text-gray-800">${lastWeek}</p><p class="text-gray-500">Last Week</p></div><div class="px-2 sm:px-3 md:px-4"><p class="font-semibold text-gray-800">${peak}</p><p class="text-gray-500">Peak</p></div><div class="px-2 sm:px-3 md:px-4 week-history-trigger cursor-pointer"><p class="font-bold text-base sm:text-lg text-gray-800">${weeks}</p><p class="text-gray-500">Weeks</p></div></div>`;

            chartRow.innerHTML = `<div class="flex items-center w-full"><div class="flex-shrink-0 flex items-center w-12 sm:w-16 text-center"><span class="text-2xl sm:text-3xl font-bold text-gray-800">${pos}</span><span class="text-base sm:text-lg ${colorClass} ml-1" title="${diff}">${icon}</span></div><div class="flex-shrink-0 mx-2 sm:mx-4 image-container">${imagePlaceholder}</div><div class="flex-grow min-w-0"><p class="text-gray-900 font-bold text-base sm:text-lg truncate">${name || artist}</p><p class="text-gray-600 text-sm sm:text-base truncate">${config.entityType !== 'artist' ? artist : ''}</p>${extraInfo}<div class="sm:hidden mt-2">${statsBlock}</div></div><div class="flex-shrink-0 ml-2 hidden sm:flex">${statsBlock}</div></div>`;
            
            const imageContainer = chartRow.querySelector('.image-container');
            loadAndSetImage(imageContainer, artist, name, config.entityType);

            if (config.entityType !== 'artist') {
                chartRow.classList.add('cursor-pointer');
                chartRow.addEventListener('click', toggleHistoryView);
            } else {
                chartRow.classList.add('cursor-pointer', 'hover:bg-gray-50');
                chartRow.addEventListener('click', (e) => {
                    if (!e.target.closest('.week-history-trigger')) { renderArtistPage(artist); }
                });
                chartRow.querySelectorAll('.week-history-trigger').forEach(trigger => {
                    trigger.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleArtistHistoryView(e.currentTarget);
                    });
                });
            }
            return chartRow;
        }

        async function loadAndSetImage(container, artist, name, type) {
            const imageUrl = await getArtworkImage(artist, name, type);
            if (imageUrl && imageUrl !== 'not_found') {
                container.innerHTML = `<img src="${imageUrl}" alt="${name || artist}" class="w-12 h-12 sm:w-16 sm:h-16 object-cover rounded-md shadow-md">`;
            }
        }

        function toggleHistoryView(event) {
            const clickedRow = event.currentTarget;
            const entityKey = clickedRow.dataset.entityKey;
            const existingHistoryView = document.querySelector('.history-view');

            if (existingHistoryView) {
                const wasOpenForThis = existingHistoryView.dataset.entityKey === entityKey;
                existingHistoryView.remove();
                if (wasOpenForThis) return;
            }

            const historyData = allHistories[activeChart][entityKey];
            const weekSelector = document.getElementById('weekSelector');
            const currentWeek = new Date(weekSelector.value.split('/').reverse().join('-'));
            
            const filteredHistory = historyData
                .filter(h => new Date(h.date.split('/').reverse().join('-')) <= currentWeek)
                .sort((a, b) => new Date(b.date.split('/').reverse().join('-')) - new Date(a.date.split('/').reverse().join('-')));

            const historyDiv = document.createElement('div');
            historyDiv.className = 'history-view bg-gray-50 p-4';
            historyDiv.dataset.entityKey = entityKey;
            
            let historyHtml = '<h4 class="font-bold text-gray-800 mb-2">Chart History</h4><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 text-sm">';
            filteredHistory.forEach(entry => {
                historyHtml += `<a href="#" data-date="${entry.date}" class="history-link flex justify-between items-center p-2 bg-gray-200 rounded-md hover:bg-red-100"><span class="text-gray-600">${entry.date}</span><span class="font-bold text-gray-800">#${entry.position}</span></a>`;
            });
            historyHtml += '</div>';
            historyDiv.innerHTML = historyHtml;
            clickedRow.after(historyDiv);

            historyDiv.querySelectorAll('.history-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('weekSelector').value = e.currentTarget.dataset.date;
                    document.getElementById('weekSelector').dispatchEvent(new Event('change'));
                });
            });
        }

        function toggleArtistHistoryView(triggerElement) {
            const artistName = triggerElement.closest('.py-3').dataset.entityKey;
            const clickedRow = triggerElement.closest('.py-3');
            const existingHistoryView = document.querySelector('.history-view');

            if (existingHistoryView) {
                const wasOpenForThis = existingHistoryView.dataset.entityKey === artistName;
                existingHistoryView.remove();
                if (wasOpenForThis) return;
            }
            
            const historyData = allHistories.artists[artistName].sort((a,b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-')));
            const chartRun = historyData.map(h => h.position).join(' - ');

            const historyDiv = document.createElement('div');
            historyDiv.className = 'history-view bg-gray-50 p-4';
            historyDiv.dataset.entityKey = artistName;
            historyDiv.innerHTML = `<h4 class="font-bold text-gray-800 mb-2">Artist 50 Chart Run</h4><p class="text-gray-700 text-sm">${chartRun}</p>`;
            clickedRow.after(historyDiv);
        }
        
        async function displayArtistHistoryCharts(artistName) {
            const stats = artistStats[artistName];
            
            const songsContainer = document.getElementById('artistSongsHistory');
            if (!stats || !stats.songs || stats.songs.items.length === 0) {
                songsContainer.innerHTML = `<p class="text-gray-600">This artist has no songs that have entered the Hot 100.</p>`;
            } else {
                const sortedSongs = stats.songs.items.sort((a, b) => {
                    if (a.peak !== b.peak) return a.peak - b.peak;
                    if (a.weeks !== b.weeks) return b.weeks - a.weeks;
                    return a.name.localeCompare(b.name);
                });
                songsContainer.innerHTML = '';
                sortedSongs.forEach(songData => songsContainer.appendChild(createArtistHistoryRow(artistName, songData, 'song')));
            }

            const albumsContainer = document.getElementById('artistAlbumsHistory');
            if (!stats || !stats.albums || stats.albums.items.length === 0) {
                albumsContainer.innerHTML = `<p class="text-gray-600">This artist has no albums that have entered the Top 100 Albums chart.</p>`;
            } else {
                const sortedAlbums = stats.albums.items.sort((a, b) => {
                    if (a.peak !== b.peak) return a.peak - b.peak;
                    if (a.weeks !== b.weeks) return b.weeks - a.weeks;
                    return a.name.localeCompare(b.name);
                });
                albumsContainer.innerHTML = '';
                sortedAlbums.forEach(albumData => albumsContainer.appendChild(createArtistHistoryRow(artistName, albumData, 'album')));
            }
        }

        function createArtistHistoryRow(artist, itemData, type) {
            const { name, peak, weeks, history } = itemData;
            const chartRun = history.sort((a,b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-'))).map(h => h.position).join(' - ');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'py-4 border-b border-gray-200';
            const initials = artist.split(' ').map(n => n[0]).join('').substring(0, 2);
            const imagePlaceholder = `<div class="w-16 h-16 bg-gray-200 rounded-md flex items-center justify-center font-bold text-gray-500 text-lg shadow-md">${initials}</div>`;
            itemDiv.innerHTML = `<div class="flex items-center"><div class="flex-shrink-0 mr-4 image-container">${imagePlaceholder}</div><div class="flex-grow"><p class="text-lg font-bold text-gray-900">${name}</p><div class="flex gap-6 text-sm mt-1"><div><span class="font-semibold">${peak}</span> <span class="text-gray-600">Peak</span></div><div><span class="font-semibold">${weeks}</span> <span class="text-gray-600">Weeks</span></div></div></div></div><div class="mt-2 text-gray-700 text-sm bg-gray-50 p-2 rounded"><span class="font-semibold">Chart Run:</span> ${chartRun}</div>`;
            const imageContainer = itemDiv.querySelector('.image-container');
            loadAndSetImage(imageContainer, artist, name, type);
            return itemDiv;
        }

        // --- INITIALIZATION AND EVENT LISTENERS ---
        async function initialize() {
            showMessage('loading', 'Loading chart data...', appContainer);
            try {
                await fetchAndProcessChartData('songs');
                renderMainPage();
                await Promise.all([ fetchAndProcessChartData('artists'), fetchAndProcessChartData('albums') ]);
                computeArtistStats();
            } catch (error) { showMessage('error', error.message, appContainer); }
        }
        
        async function switchChart(chartType) {
            activeChart = chartType;
            const chartTitleEl = document.getElementById('chartTitle');
            chartTitleEl.textContent = chartsConfig[activeChart].title;
            
            document.querySelectorAll('.chart-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.chart === chartType);
            });

            if (!chartsConfig[chartType].loaded) {
                try {
                    showMessage('loading', `Loading ${chartsConfig[chartType].title} chart data...`);
                    await fetchAndProcessChartData(chartType);
                    computeArtistStats();
                } catch (error) { showMessage('error', error.message); return; }
            }

            populateWeekSelector();
            const weekSelector = document.getElementById('weekSelector');
            
            if (lastSelectedWeeks[chartType] && weekSelector.querySelector(`option[value="${lastSelectedWeeks[chartType]}"]`)) {
                weekSelector.value = lastSelectedWeeks[chartType];
            }

            const selectedWeek = weekSelector.value || weekSelector.options[0]?.value;
            lastSelectedWeeks[activeChart] = selectedWeek;

            if (selectedWeek) { await displayActiveChart(selectedWeek); } 
            else { showMessage('info', `No data found for the ${chartsConfig[activeChart].title} chart.`); }
            updateWeekNavButtons();
        }

        function updateWeekNavButtons() {
            const weekSelector = document.getElementById('weekSelector');
            const prevWeekBtn = document.getElementById('prevWeekBtn'), nextWeekBtn = document.getElementById('nextWeekBtn');
            if (!weekSelector || !prevWeekBtn || !nextWeekBtn) return;
            const currentIndex = weekSelector.selectedIndex;
            nextWeekBtn.disabled = currentIndex === 0;
            prevWeekBtn.disabled = currentIndex === weekSelector.options.length - 1;
        }
        
        function setupMainPageListeners() {
            document.addEventListener('click', function(e) {
                const target = e.target;
                const weekSelector = document.getElementById('weekSelector');

                if (target.closest('.chart-nav-btn')) {
                    switchChart(target.closest('.chart-nav-btn').dataset.chart);
                } else if (target.id === 'prevWeekBtn' && weekSelector) {
                    if (weekSelector.selectedIndex < weekSelector.options.length - 1) {
                        weekSelector.selectedIndex++;
                        weekSelector.dispatchEvent(new Event('change'));
                    }
                } else if (target.id === 'nextWeekBtn' && weekSelector) {
                    if (weekSelector.selectedIndex > 0) {
                        weekSelector.selectedIndex--;
                        weekSelector.dispatchEvent(new Event('change'));
                    }
                }
            });

            document.addEventListener('change', function(e) {
                if (e.target.id === 'weekSelector') {
                    lastSelectedWeeks[activeChart] = e.target.value;
                    displayActiveChart(e.target.value);
                    updateWeekNavButtons();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>